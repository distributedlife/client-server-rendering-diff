'use strict';

var $ = require('zepto-browserify').$;

module.exports = {
  type: 'View',
  deps: ['Element', 'Dimensions', 'StateTracker'],
  func: function (element, dimensions, tracker) {
    var canvas;
    var context;
    var dims;

    var updateBall = function(currentPosition, priorPosition, colour) {
      context.fillStyle = colour;

      if (currentPosition === undefined) {
        context.beginPath();
        context.arc(priorPosition.x,priorPosition.y,25,0,2*Math.PI);
        context.closePath();
        context.fill();
      } else {
        context.beginPath();
        context.arc(currentPosition.x,currentPosition.y,25,0,2*Math.PI);
        context.closePath();
        context.fill();
      }
    };

    var theBallPosition = function (state) {
      return state['bouncing-ball-game'].ball.position;
    };

    var position = {
      x: 100,
      y: 50
    };
    var speed = {
      x: 100,
      y: 50
    };

    var updateClientPosition = function(delta) {
      position.x += speed.x * delta;
      position.y += speed.y * delta;

      if ((position.x > 500) || (position.x < 0)) {
        speed.x = speed.x * -1;
      }
      if ((position.y > 500) || (position.y < 0)) {
        speed.y = speed.y * -1;
      }
    };

    var preCalculatedServerSideValues = [
      {x:105.60, y:52.800},
      {x:110.50, y:55.250},
      {x:115.00, y:57.500},
      {x:119.80, y:59.900},
      {x:124.50, y:62.250},
      {x:129.40, y:64.700},
      {x:134.00, y:67.000},
      {x:138.70, y:69.350},
      {x:143.20, y:71.600},
      {x:147.80, y:73.900},
      {x:152.50, y:76.250},
      {x:157.10, y:78.550},
      {x:161.80, y:80.900},
      {x:167.20, y:83.600},
      {x:171.30, y:85.650},
      {x:176.50, y:88.250},
      {x:180.30, y:90.150},
      {x:185.00, y:92.500},
      {x:189.70, y:94.850},
      {x:195.10, y:97.550},
      {x:198.90, y:99.450},
      {x:204.40, y:102.20},
      {x:209.00, y:104.50},
      {x:213.60, y:106.80},
      {x:218.30, y:109.15},
      {x:222.30, y:111.15},
      {x:227.10, y:113.55},
      {x:231.90, y:115.95},
      {x:236.90, y:118.45},
      {x:241.30, y:120.65},
      {x:246.80, y:123.40},
      {x:251.20, y:125.60},
      {x:256.00, y:128.00},
      {x:260.80, y:130.40},
      {x:264.90, y:132.45},
      {x:269.60, y:134.80},
      {x:274.40, y:137.20},
      {x:279.10, y:139.55},
      {x:283.70, y:141.85},
      {x:288.20, y:144.10},
      {x:292.70, y:146.35},
      {x:298.30, y:149.15},
      {x:302.90, y:151.45},
      {x:307.30, y:153.65},
      {x:312.09, y:156.04},
      {x:316.59, y:158.29},
      {x:321.19, y:160.59},
      {x:325.59, y:162.79},
      {x:330.99, y:165.49},
      {x:335.69, y:167.84},
      {x:340.29, y:170.14},
      {x:344.19, y:172.09},
      {x:348.79, y:174.39},
      {x:353.29, y:176.64},
      {x:357.99, y:178.99},
      {x:362.59, y:181.29},
      {x:367.09, y:183.54},
      {x:372.19, y:186.09},
      {x:376.59, y:188.29},
      {x:382.19, y:191.09},
      {x:386.89, y:193.44},
      {x:391.59, y:195.79},
      {x:396.19, y:198.09},
      {x:400.69, y:200.34},
      {x:405.19, y:202.59},
      {x:409.19, y:204.59},
      {x:413.79, y:206.89},
      {x:419.39, y:209.69},
      {x:423.19, y:211.59},
      {x:427.69, y:213.84},
      {x:432.69, y:216.34},
      {x:437.39, y:218.69},
      {x:442.09, y:221.04},
      {x:447.39, y:223.69},
      {x:452.09, y:226.04},
      {x:456.79, y:228.39},
      {x:460.89, y:230.44},
      {x:465.39, y:232.69},
      {x:469.89, y:234.94},
      {x:474.79, y:237.39},
      {x:479.69, y:239.84},
      {x:484.19, y:242.09},
      {x:488.89, y:244.44},
      {x:493.49, y:246.74},
      {x:498.19, y:249.09},
      {x:498.99, y:251.39},
      {x:493.69, y:254.04},
      {x:489.59, y:256.09},
      {x:485.09, y:258.34},
      {x:480.59, y:260.59},
      {x:475.09, y:263.34},
      {x:471.39, y:265.19},
      {x:466.49, y:267.64},
      {x:461.69, y:270.04},
      {x:456.99, y:272.39},
      {x:452.39, y:274.69},
      {x:447.69, y:277.04},
      {x:442.39, y:279.69},
      {x:437.89, y:281.94},
      {x:433.39, y:284.19},
      {x:428.79, y:286.49},
      {x:424.09, y:288.84},
      {x:419.29, y:291.24},
      {x:414.79, y:293.49},
      {x:410.19, y:295.79},
      {x:405.69, y:298.04},
      {x:401.09, y:300.34},
      {x:396.29, y:302.74},
      {x:390.99, y:305.39},
      {x:386.19, y:307.79},
      {x:381.69, y:310.04},
      {x:376.79, y:312.49},
      {x:373.00, y:314.39},
      {x:368.10, y:316.84},
      {x:363.50, y:319.14},
      {x:357.90, y:321.94},
      {x:354.10, y:323.84},
      {x:348.80, y:326.49},
      {x:344.30, y:328.74},
      {x:340.40, y:330.69},
      {x:335.70, y:333.04},
      {x:330.80, y:335.49},
      {x:326.30, y:337.74},
      {x:320.80, y:340.49},
      {x:316.40, y:342.69},
      {x:311.90, y:344.94},
      {x:307.40, y:347.19},
      {x:302.90, y:349.44},
      {x:298.40, y:351.69},
      {x:292.60, y:354.59},
      {x:288.10, y:356.84},
      {x:282.40, y:359.69},
      {x:277.80, y:361.99},
      {x:273.20, y:364.29},
      {x:267.70, y:367.04},
      {x:263.70, y:369.04},
      {x:258.40, y:371.69},
      {x:253.70, y:374.04},
      {x:249.20, y:376.29},
      {x:244.60, y:378.59},
      {x:240.00, y:380.89},
      {x:235.60, y:383.09},
      {x:231.00, y:385.39},
      {x:226.50, y:387.64},
      {x:221.60, y:390.09},
      {x:216.80, y:392.49},
      {x:212.20, y:394.79},
      {x:207.70, y:397.04},
      {x:203.40, y:399.19},
      {x:198.80, y:401.49},
      {x:194.00, y:403.89},
      {x:189.40, y:406.19},
      {x:184.50, y:408.64},
      {x:180.00, y:410.89},
      {x:175.30, y:413.24},
      {x:170.70, y:415.54},
      {x:166.20, y:417.79},
      {x:161.80, y:419.99},
      {x:157.30, y:422.24},
      {x:152.70, y:424.54},
      {x:147.20, y:427.29},
      {x:142.50, y:429.64},
      {x:138.10, y:431.84},
      {x:133.20, y:434.29},
      {x:128.80, y:436.49},
      {x:124.10, y:438.84},
      {x:119.60, y:441.09},
      {x:115.20, y:443.29},
      {x:110.40, y:445.69},
      {x:105.70, y:448.04},
      {x:101.10, y:450.34},
      {x:96.600, y:452.59},
      {x:92.000, y:454.89},
      {x:86.500, y:457.64},
      {x:82.700, y:459.54},
      {x:77.900, y:461.94},
      {x:72.400, y:464.69},
      {x:68.000, y:466.89},
      {x:63.300, y:469.24},
      {x:58.700, y:471.54},
      {x:54.200, y:473.79},
      {x:49.600, y:476.09},
      {x:45.000, y:478.39},
      {x:40.400, y:480.69},
      {x:35.900, y:482.94},
      {x:31.500, y:485.14},
      {x:26.900, y:487.44},
      {x:22.300, y:489.74},
      {x:17.400, y:492.19},
      {x:13.000, y:494.39},
      {x:8.4000, y:496.69},
      {x:2.9000, y:499.44},
      {x:0.7000, y:499.44},
      {x:5.2000, y:497.19},
      {x:9.7000, y:494.94},
      {x:14.500, y:492.54},
      {x:19.900, y:489.84},
      {x:24.300, y:487.64},
      {x:29.000, y:485.29},
      {x:33.400, y:483.09},
      {x:37.900, y:480.84},
      {x:42.600, y:478.49},
      {x:47.200, y:476.19},
      {x:52.500, y:473.54},
      {x:57.100, y:471.24},
      {x:61.600, y:468.99},
      {x:65.500, y:467.04},
      {x:70.200, y:464.69},
      {x:75.000, y:462.29},
      {x:79.500, y:460.04},
      {x:84.200, y:457.69},
      {x:88.900, y:455.34},
      {x:93.700, y:452.94},
      {x:97.300, y:451.14},
      {x:102.00, y:448.79},
      {x:107.50, y:446.04},
      {x:111.20, y:444.19},
      {x:115.70, y:441.94},
      {x:121.40, y:439.09},
      {x:125.40, y:437.09},
      {x:130.50, y:434.54},
      {x:134.50, y:432.54},
      {x:139.00, y:430.29},
      {x:143.50, y:428.04},
      {x:148.00, y:425.79},
      {x:152.60, y:423.49},
      {x:157.30, y:421.14},
      {x:162.70, y:418.44},
      {x:167.30, y:416.14},
      {x:171.20, y:414.19},
      {x:175.80, y:411.89},
      {x:180.40, y:409.59},
      {x:185.20, y:407.19},
      {x:190.20, y:404.69},
      {x:194.70, y:402.44},
      {x:199.40, y:400.09},
      {x:204.10, y:397.74},
      {x:208.60, y:395.49},
      {x:213.10, y:393.24},
      {x:217.70, y:390.94},
      {x:222.50, y:388.54},
      {x:227.20, y:386.19},
      {x:231.80, y:383.89},
      {x:237.20, y:381.19},
      {x:241.70, y:378.94},
      {x:246.40, y:376.59},
      {x:251.00, y:374.29},
      {x:255.60, y:371.99},
      {x:259.50, y:370.04},
      {x:264.20, y:367.69},
      {x:268.80, y:365.39},
      {x:273.40, y:363.09},
      {x:278.00, y:360.79},
      {x:282.50, y:358.54},
      {x:287.00, y:356.29},
      {x:291.50, y:354.04},
      {x:296.10, y:351.74},
      {x:300.80, y:349.39},
      {x:306.40, y:346.59},
      {x:310.30, y:344.64},
      {x:315.20, y:342.19},
      {x:319.89, y:339.84},
      {x:324.49, y:337.54},
      {x:329.09, y:335.24},
      {x:333.99, y:332.79},
      {x:338.69, y:330.44},
      {x:343.19, y:328.19},
      {x:347.69, y:325.94},
      {x:353.09, y:323.24},
      {x:357.59, y:320.99},
      {x:361.59, y:318.99},
      {x:366.19, y:316.69},
      {x:370.69, y:314.44},
      {x:375.39, y:312.09},
      {x:379.99, y:309.79},
      {x:385.39, y:307.09},
      {x:389.19, y:305.19},
      {x:390.99, y:304.29}
    ];

    var each = require('lodash').each;
    var time = 0;
    each(preCalculatedServerSideValues, function(value) {
      value.time = time;
      time += 0.045;
    });
    var elapsedTime = 0;
    var i = 0;

    return {
      update: function (delta) {
        if (context === undefined) {
          return;
        }

        elapsedTime += delta;
        if (preCalculatedServerSideValues[i + 1]) {
          if (preCalculatedServerSideValues[i + 1].time < elapsedTime) {
            i += 1;
          }
        }

        updateClientPosition(delta);

        context.clearRect(0, 0, canvas[0].width, canvas[0].height);

        updateBall(tracker().get(theBallPosition), undefined, 'blue');
        updateBall(position, undefined, 'red');
        updateBall(preCalculatedServerSideValues[i], undefined, 'green');
      },
      setup: function () {
        dims = dimensions().get();

        canvas = $('<canvas/>', { id: 'scene' });
        canvas[0].width = dims.usableWidth;
        canvas[0].height = dims.usableHeight;
        context = canvas[0].getContext('2d');

        $('#' + element()).append(canvas);
      },
      screenResized: function () {
        dims = dimensions().get();

        if (canvas !== undefined) {
          canvas[0].width = dims.usableWidth;
          canvas[0].height = dims.usableHeight;
        }
      }
    };
  }
};